/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.32/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import r from"../../../../core/Collection.js";import o from"../../../../core/ReactiveMap.js";import{property as a}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as s}from"../../../../core/accessorSupport/decorators/subclass.js";import{mapSpaceToImageSpace as i}from"../../dataCaptureUtils.js";import{SketchHandlerMixin as c}from"../../mixins/SketchHandlerMixin.js";let p=class extends(c(t)){constructor(e){super(e),this.savedGraphics=new r,this.type="data-capture",this.pendingGraphics=new o}get collectionId(){return this.viewModel.collectionId}handleCreate(e){const{state:t,graphic:r,tool:o}=e,a=r?.geometry;if("complete"!==t||!r||!a)return;const{collectionId:s,viewModel:{dataCaptureLayer:i,currentBestFeature:c,imageGeometryField:p,oiObjectIdField:n,activeViewer:l,mode:h},pendingGraphics:u}=this,m=l?.imageSize;c&&p&&s&&n&&i&&m&&"none"!==h&&(d(r,a,p,n,c,u,s,m,h,i),this.viewModel.emit("after-data-capture-complete",{pendingGraphics:u.get(s)?.toArray()??null}),this.viewModel.sketch?.create(o))}handleDelete(e){const{dataCaptureLayer:t}=this.viewModel;if(!t)return;const{graphics:r}=e;this.pendingGraphics.get(t.id)?.removeMany(r),this.savedGraphics.removeMany(r),this.viewModel.deleteDataCaptureFeatures(n(r,t.objectIdField))}handleDestroy(){const{dataCaptureLayer:e}=this.viewModel;e&&(this.viewModel.stopDataCapture(),this.savedGraphics.removeAll(),this.pendingGraphics=null)}handleUpdate(e){const{toolEventInfo:t,state:r,graphics:o}=e;if(t)this.viewModel.sketch?.undo();else switch(r){case"complete":this.viewModel.emit("deselect-data-capture-features",{graphics:o});break;case"start":this.viewModel.emit("select-data-capture-features",{graphics:o})}}};function d(e,t,o,a,s,c,p,d,n,l){e.sourceLayer=l,e.attributes=e.attributes??{},e.attributes[o]=btoa(JSON.stringify({geometry:i(t.clone(),n,d).toJSON()})),e.attributes[a]=s.attributes.objectId,c.has(p)||c.set(p,new r);c.get(p).add(e)}function n(e,t){return e.map((({attributes:e})=>t?e[t]:null)).filter(Boolean)}e([a()],p.prototype,"collectionId",null),e([a()],p.prototype,"savedGraphics",void 0),e([a()],p.prototype,"type",void 0),e([a()],p.prototype,"pendingGraphics",void 0),p=e([s("esri.widgets.OrientedImageryViewer.adapters.sketch.DataCaptureAdapter")],p);const l=p;export{l as default};
